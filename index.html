<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FUMMSA Face of the Week</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
  .container { max-width: 500px; margin: auto; }
  form, .list-section { background: #fff; padding: 25px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  input, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
  button { background: #3498db; color: #fff; border: none; cursor: pointer; font-weight: bold; transition: background 0.3s ease; }
  button:hover { background: #2980b9; }
  .hidden { display: none; }
  .pts { float: right; font-weight: bold; color: #e67e22; }
  h1, h3 { text-align: center; color: #2c3e50; }
  hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 10px; }
  td { padding: 8px; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<div class="container">
    <h1>FUMMSA Face of the Week</h1>

    <div style="text-align: center; margin-bottom: 15px; font-size: 1.1em;">
      Slots Remaining: <span id="slotsLeft" style="font-weight:bold; color: #e74c3c;">20</span> / 20
    </div>
    
    <div id="regSection">
      <form id="registrationForm">
        <h3>1. Contestant Registration</h3>
        <input type="text" id="regName" placeholder="Full Name" required>
        <input type="text" id="regUsername" placeholder="TikTok Username" required>
        <button type="submit">Join Contest</button>
      </form>
    </div>

    <div id="refSection" class="hidden">
      <form id="referralForm">
        <h3 id="refTitle">Dashboard</h3>
        <div id="contestantControls" class="hidden">
           <button type="button" id="shareBtn" style="background:#27ae60;">Copy My Referral Link üîó</button>
           <hr>
        </div>
        <div id="votingInputs">
          <p id="refInstructions" style="text-align:center;">Enter your handle to support this contestant:</p>
          <input type="text" id="friendHandle" placeholder="Your TikTok Username" required>
          <button type="submit">Submit Vote</button>
        </div>
        <button type="button" onclick="logout()" style="background:#95a5a6; margin-top:10px;">Logout / Exit</button>
      </form>
    </div>

    <div class="list-section">
      <h3>üèÜ Current Standings</h3>
      <ul id="leaderboard" style="list-style: none; padding: 0;"></ul>
    </div>

    <div class="list-section" style="border-top: 3px solid #e74c3c; margin-top: 40px;">
      <h3>üîç Admin: Vote Logs</h3>
      <button onclick="viewVotes()" style="background:#2c3e50;">Unlock Voter List</button>
      <button id="csvBtn" class="hidden" onclick="downloadCSV()" style="background:#27ae60; margin-top:10px;">Download Excel (CSV) üìä</button>
      <div id="adminContainer" class="hidden">
        <table>
          <tbody id="adminVoteList"></tbody>
        </table>
      </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // Your specific database URL
  const firebaseConfig = {
    databaseURL: "https://fummsa-creatives-9e579-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const clean = (str) => str.trim().toLowerCase().replace(/[^a-z0-9]/g, "");

  let currentCount = 0;
  let referrerUid = ""; 
  let allVotesData = null;

  window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    referrerUid = clean(urlParams.get('ref') || "");
    const savedUser = sessionStorage.getItem("fow_user");
    if (savedUser) showDashboard(savedUser, true);
    else if (referrerUid) showDashboard(referrerUid, false);
  };

  function showDashboard(id, isOwner) {
    document.getElementById('regSection').classList.add('hidden');
    document.getElementById('refSection').classList.remove('hidden');
    if (isOwner) {
      document.getElementById('refTitle').innerText = "Contestant: " + id;
      document.getElementById('contestantControls').classList.remove('hidden');
      document.getElementById('votingInputs').classList.add('hidden'); 
    } else {
      document.getElementById('refTitle').innerText = "Supporting: " + id;
      document.getElementById('contestantControls').classList.add('hidden');
      document.getElementById('votingInputs').classList.remove('hidden');
    }
  }

  onValue(ref(db, '/'), (snap) => {
    const root = snap.val() || {};
    const participants = root.participants || {};
    allVotesData = root.usedHandles || {}; 
    currentCount = Object.keys(participants).length;
    document.getElementById('slotsLeft').innerText = Math.max(0, 20 - currentCount);
    const list = document.getElementById('leaderboard');
    list.innerHTML = "";
    Object.values(participants).sort((a,b) => b.points - a.points).forEach((p, i) => {
      list.innerHTML += `<li>#${i+1} ${p.name} <span class="pts">${p.points} Pts</span></li>`;
    });
  });

  document.getElementById('registrationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('regName').value.trim();
    const username = clean(document.getElementById('regUsername').value);
    try {
        await set(ref(db, 'participants/' + username), { name: name, points: 0 });
        sessionStorage.setItem("fow_user", username);
        location.reload(); 
    } catch (err) {
        alert("Permission Denied: Ensure 'ezrielleverse.github.io' is authorized in Firebase Settings.");
    }
  });

  document.getElementById('referralForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const friend = clean(document.getElementById('friendHandle').value);
    if (!referrerUid || referrerUid === sessionStorage.getItem("fow_user")) return alert("Self-voting disabled!");
    const usedSnap = await get(ref(db, 'usedHandles/' + friend));
    if (usedSnap.exists()) return alert("Already voted!");
    const contestantRef = ref(db, 'participants/' + referrerUid);
    const contestantSnap = await get(contestantRef);
    await update(contestantRef, { points: (contestantSnap.val().points || 0) + 1 });
    await set(ref(db, 'usedHandles/' + friend), { votedFor: referrerUid, time: new Date().toLocaleTimeString() });
    alert("Voted!");
    e.target.reset();
  });

  window.viewVotes = () => {
    if (prompt("Admin Password:") === "FUMMSA2026") {
        document.getElementById('adminContainer').classList.remove('hidden');
        document.getElementById('csvBtn').classList.remove('hidden');
        const list = document.getElementById('adminVoteList');
        list.innerHTML = "";
        for (let friend in allVotesData) {
            list.innerHTML += `<tr><td>@${friend}</td><td>voted for ${allVotesData[friend].votedFor}</td><td>${allVotesData[friend].time}</td></tr>`;
        }
    }
  };

  window.downloadCSV = () => {
    let csv = "Voter,Candidate,Time\n";
    for (let f in allVotesData) csv += `@${f},${allVotesData[f].votedFor},${allVotesData[f].time}\n`;
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'FUMMSA_Votes.csv'; a.click();
  };

  document.getElementById('shareBtn').onclick = () => {
    const url = window.location.origin + window.location.pathname + "?ref=" + sessionStorage.getItem("fow_user");
    navigator.clipboard.writeText(url).then(() => alert("Link copied!"));
  };

  window.logout = () => {
    sessionStorage.clear();
    window.location.href = window.location.origin + window.location.pathname;
  };
</script>
</body>
</html>
